services:
  agent-runner:
    image: crypton-agent-runner:latest
    build:
      context: .
      dockerfile: src/Crypton.Api.AgentRunner/Dockerfile
    container_name: crypton-agent-runner
    ports:
      - "127.0.0.1:5003:5003"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:5003
      - Tools__BraveSearch__ApiKey=${BRAVE_SEARCH_API_KEY}
      - Api__ApiKey=${AGENT_RUNNER_API_KEY}
      - Tools__MarketDataService__BaseUrl=http://market-data-service:5002
    volumes:
      - /home/matthew-evans/.config/crypton/artifacts:/app/artifacts
      - /home/matthew-evans/.config/crypton/logs:/app/logs
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  market-data-service:
    image: crypton-market-data-service:latest
    build:
      context: .
      dockerfile: src/Crypton.Api.MarketData/Dockerfile
    container_name: crypton-market-data-service
    ports:
      - "127.0.0.1:5002:5002"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:5002
      - Kraken__ApiKey=${KRAKEN_API_KEY}
      - Kraken__ApiSecret=${KRAKEN_SECRET_KEY}
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  execution-service:
    image: crypton-execution-service:latest
    build:
      context: .
      dockerfile: src/Crypton.Api.ExecutionService/Dockerfile
    container_name: crypton-execution-service
    ports:
      - "127.0.0.1:5004:5004"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:5004
      - EXECUTION_SERVICE__KRAKEN__ApiKey=${KRAKEN_API_KEY}
      - EXECUTION_SERVICE__KRAKEN__ApiSecret=${KRAKEN_SECRET_KEY}
      - EXECUTION_SERVICE__API__ApiKey=${EXECUTION_SERVICE_API_KEY}
    volumes:
      - /home/matthew-evans/.config/crypton/execution/artifacts:/app/artifacts
      - /home/matthew-evans/.config/crypton/execution/logs:/app/logs
    depends_on:
      market-data-service:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  monitoring-dashboard-api:
    image: crypton-monitoring-dashboard-api:latest
    build:
      context: .
      dockerfile: src/Crypton.Api.MonitoringDashboard/Dockerfile
    container_name: crypton-monitoring-dashboard-api
    ports:
      - "127.0.0.1:5001:5001"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:5001
      - MarketDataService__Url=http://market-data-service:5002
    depends_on:
      market-data-service:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  monitoring-dashboard-web:
    image: crypton-monitoring-dashboard-web:latest
    build:
      context: .
      dockerfile: src/Crypton.Web.Dashboard/Dockerfile
    container_name: crypton-monitoring-dashboard-web
    ports:
      - "127.0.0.1:5000:5000"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

