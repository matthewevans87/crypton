name: Deploy Crypton Stack

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Clean up old images
        run: |
          for service in agent-runner monitoring-dashboard-api monitoring-dashboard-web market-data-service; do
            docker rmi crypton-$service:latest || true
          done

      - name: Build Agent Runner
        run: |
          for attempt in 1 2 3; do
            docker build --no-cache --load --provenance=false \
              --tag crypton-agent-runner:latest \
              -f src/Crypton.Api.AgentRunner/Dockerfile . && break
            echo "Attempt $attempt failed, retrying in 15s..."
            sleep 15
          done

      - name: Build Monitoring Dashboard Backend
        run: |
          for attempt in 1 2 3; do
            docker build --no-cache --load --provenance=false \
              --tag crypton-monitoring-dashboard-api:latest \
              -f src/Crypton.Api.MonitoringDashboard/Dockerfile . && break
            echo "Attempt $attempt failed, retrying in 15s..."
            sleep 15
          done

      - name: Build Monitoring Dashboard Frontend
        run: |
          for attempt in 1 2 3; do
            docker build --no-cache --load --provenance=false \
              --tag crypton-monitoring-dashboard-web:latest \
              -f src/Crypton.Web.Dashboard/Dockerfile . && break
            echo "Attempt $attempt failed, retrying in 15s..."
            sleep 15
          done

      - name: Build Market Data Service
        run: |
          for attempt in 1 2 3; do
            docker build --no-cache --load --provenance=false \
              --tag crypton-market-data-service:latest \
              -f src/Crypton.Api.MarketData/Dockerfile . && break
            echo "Attempt $attempt failed, retrying in 15s..."
            sleep 15
          done

      - name: Prune dangling images
        run: docker image prune -f

  deploy:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Deploy all services
        run: docker compose -f $GITHUB_WORKSPACE/docker-compose.yml up -d --no-build

  verify:
    runs-on: self-hosted
    needs: deploy
    steps:
      - name: Verify containers running
        run: |
          echo "Running containers:"
          docker ps --filter "name=crypton-"

          echo ""
          echo "Container logs:"
          for container in crypton-agent-runner crypton-market-data-service crypton-monitoring-dashboard-api crypton-monitoring-dashboard-web; do
            echo "=== $container (last 5 lines) ==="
            docker logs --tail 5 $container 2>&1 || true
          done

  finish:
    runs-on: self-hosted
    needs: verify
    steps:
      - name: Report success
        run: |
          echo "Deployment complete!"
          echo ""
          echo "Services deployed:"
          echo "  - Dashboard Web:       http://localhost:5000"
          echo "  - Dashboard API:       http://localhost:5001"
          echo "  - Market Data Service: http://localhost:5002"
          echo "  - Agent Runner:        http://localhost:5003"
